<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ğŸ”® AI å¡”ç¾…å åœ Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=Noto+Serif+TC:wght@400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-primary: #0a0a0f; --bg-secondary: #16161f; --bg-tertiary: #1e1e2a;
            --bg-card: linear-gradient(145deg, #1a1a25, #12121a);
            --text-primary: #f0e6d3; --text-secondary: #a09080; --text-gold: #d4af37;
            --accent-purple: #9b59b6; --accent-blue: #3498db; --accent-gold: #f39c12;
            --accent-red: #e74c3c; --accent-green: #27ae60; --accent-pink: #e91e63;
            --border-color: #2a2a3a; --glow-purple: rgba(155, 89, 182, 0.3); --glow-gold: rgba(212, 175, 55, 0.3);
            --safe-top: env(safe-area-inset-top, 47px); --safe-bottom: env(safe-area-inset-bottom, 34px);
            --neon-cyan: #00f5ff; --neon-purple: #bf00ff; --neon-blue: #0080ff;
        }
        
        .splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at center, #0a0a1a 0%, #000000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.8s ease, visibility 0.8s ease; }
        .splash-screen.fade-out { opacity: 0; visibility: hidden; }
        .splash-container { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; }
        .splash-text { font-family: 'Noto Serif TC', serif; font-size: 100px; font-weight: 700; color: transparent; background: linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-purple) 50%, var(--neon-cyan) 100%); background-size: 200% 200%; -webkit-background-clip: text; background-clip: text; animation: textGlow 2s ease-in-out infinite, textShine 3s linear infinite; filter: drop-shadow(0 0 20px var(--neon-cyan)) drop-shadow(0 0 40px var(--neon-purple)); z-index: 10; }
        @keyframes textGlow { 0%, 100% { filter: drop-shadow(0 0 20px var(--neon-cyan)) drop-shadow(0 0 40px var(--neon-purple)); } 50% { filter: drop-shadow(0 0 40px var(--neon-cyan)) drop-shadow(0 0 60px var(--neon-purple)) drop-shadow(0 0 80px var(--neon-blue)); } }
        @keyframes textShine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        .ring-1 { position: absolute; width: 100%; height: 100%; border: 3px solid transparent; border-top-color: var(--neon-cyan); border-right-color: var(--neon-cyan); border-radius: 50%; animation: spin 2s linear infinite; box-shadow: 0 0 20px var(--neon-cyan), inset 0 0 20px rgba(0, 245, 255, 0.1); }
        .ring-2 { position: absolute; width: 85%; height: 85%; border: 2px solid transparent; border-bottom-color: var(--neon-purple); border-left-color: var(--neon-purple); border-radius: 50%; animation: spin-reverse 1.5s linear infinite; box-shadow: 0 0 15px var(--neon-purple), inset 0 0 15px rgba(191, 0, 255, 0.1); }
        .ring-3 { position: absolute; width: 70%; height: 70%; border: 2px dashed var(--neon-blue); border-radius: 50%; animation: spin 3s linear infinite; opacity: 0.6; }
        .bagua-ring { position: absolute; width: 110%; height: 110%; animation: spin-reverse 10s linear infinite; }
        .bagua-symbol { position: absolute; font-size: 20px; color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); animation: symbolPulse 2s ease-in-out infinite; }
        .bagua-symbol:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); } .bagua-symbol:nth-child(2) { top: 15%; right: 15%; animation-delay: 0.25s; } .bagua-symbol:nth-child(3) { top: 50%; right: 0; transform: translateY(-50%); animation-delay: 0.5s; } .bagua-symbol:nth-child(4) { bottom: 15%; right: 15%; animation-delay: 0.75s; } .bagua-symbol:nth-child(5) { bottom: 0; left: 50%; transform: translateX(-50%); animation-delay: 1s; } .bagua-symbol:nth-child(6) { bottom: 15%; left: 15%; animation-delay: 1.25s; } .bagua-symbol:nth-child(7) { top: 50%; left: 0; transform: translateY(-50%); animation-delay: 1.5s; } .bagua-symbol:nth-child(8) { top: 15%; left: 15%; animation-delay: 1.75s; }
        @keyframes symbolPulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
        .particles { position: absolute; width: 100%; height: 100%; overflow: hidden; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: var(--neon-cyan); border-radius: 50%; animation: particleFloat 3s ease-in-out infinite; box-shadow: 0 0 10px var(--neon-cyan); }
        .particle:nth-child(1) { left: 10%; } .particle:nth-child(2) { left: 20%; animation-delay: 0.5s; } .particle:nth-child(3) { left: 30%; animation-delay: 1s; } .particle:nth-child(4) { left: 40%; animation-delay: 1.5s; } .particle:nth-child(5) { left: 50%; animation-delay: 0.3s; } .particle:nth-child(6) { left: 60%; animation-delay: 0.8s; } .particle:nth-child(7) { left: 70%; animation-delay: 1.3s; } .particle:nth-child(8) { left: 80%; animation-delay: 0.6s; } .particle:nth-child(9) { left: 90%; animation-delay: 1.1s; }
        @keyframes particleFloat { 0% { bottom: -10px; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { bottom: 100%; opacity: 0; } }
        .splash-loading { margin-top: 60px; text-align: center; }
        .splash-title { font-family: 'Noto Serif TC', serif; font-size: 24px; color: var(--neon-cyan); text-shadow: 0 0 20px var(--neon-cyan); margin-bottom: 16px; animation: titlePulse 2s ease-in-out infinite; }
        @keyframes titlePulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
        .splash-subtitle { font-size: 14px; color: #666; letter-spacing: 4px; }
        .progress-bar { width: 200px; height: 3px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; margin-top: 24px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple), var(--neon-cyan)); background-size: 200% 100%; border-radius: 2px; animation: progressAnim 2s ease-in-out forwards, progressShine 1s linear infinite; }
        @keyframes progressAnim { 0% { width: 0%; } 100% { width: 100%; } }
        @keyframes progressShine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }

        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; min-height: 100dvh; overflow-x: hidden; background-image: radial-gradient(ellipse at top, rgba(155, 89, 182, 0.1) 0%, transparent 50%), radial-gradient(ellipse at bottom, rgba(212, 175, 55, 0.05) 0%, transparent 50%); }
        .app-container { max-width: 430px; margin: 0 auto; min-height: 100vh; min-height: 100dvh; position: relative; }
        .status-bar { height: calc(var(--safe-top) + 0px); min-height: 47px; background: transparent; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 24px 8px; font-size: 14px; font-weight: 600; position: fixed; top: 0; left: 0; right: 0; max-width: 430px; margin: 0 auto; z-index: 100; }
        .dynamic-island { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 126px; height: 37px; background: #000; border-radius: 20px; }
        .top-toolbar { position: fixed; top: calc(var(--safe-top) + 10px); right: 20px; display: flex; gap: 10px; z-index: 101; }
        .toolbar-btn { background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; transition: all 0.2s; }
        .toolbar-btn:active { transform: scale(0.9); }
        .main-content { padding: calc(var(--safe-top) + 20px) 16px calc(var(--safe-bottom) + 80px); }
        .header { text-align: center; margin-bottom: 20px; }
        .header-icon { font-size: 50px; margin-bottom: 8px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .header h1 { font-family: 'Noto Serif TC', serif; font-size: 26px; font-weight: 700; background: linear-gradient(135deg, var(--text-gold) 0%, #fff 50%, var(--text-gold) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 6px; }
        .header p { color: var(--text-secondary); font-size: 13px; }
        .spread-selector { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0 16px; margin-bottom: 16px; -webkit-overflow-scrolling: touch; }
        .spread-selector::-webkit-scrollbar { display: none; }
        .spread-btn { flex-shrink: 0; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 16px; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .spread-btn.active { background: linear-gradient(135deg, var(--accent-purple), #8e44ad); border-color: var(--accent-purple); color: white; box-shadow: 0 0 15px var(--glow-purple); }
        .question-input { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 14px 16px; margin-bottom: 16px; }
        .question-input input { width: 100%; background: transparent; border: none; color: var(--text-primary); font-size: 15px; outline: none; }
        .question-input input::placeholder { color: var(--text-secondary); }
        .tarot-area { min-height: 200px; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .tarot-spread { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 16px 0; perspective: 1000px; }
        .tarot-card { width: 70px; height: 110px; background: linear-gradient(145deg, #2a1f4e, #1a1030); border: 2px solid var(--text-gold); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; transition: all 0.5s ease; transform-style: preserve-3d; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .tarot-card.large { width: 90px; height: 140px; font-size: 36px; }
        .tarot-card:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(155, 89, 182, 0.3); }
        .tarot-card:active { transform: scale(0.95); }
        .tarot-card.flipped { transform: rotateY(180deg); }
        .tarot-card.reversed .card-front { transform: rotateY(180deg) rotateZ(180deg); }
        .tarot-card .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; background: linear-gradient(145deg, #2a1f4e, #1a1030); }
        .tarot-card .card-front { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; background: linear-gradient(145deg, #f5f0e1, #e8dcc8); color: #2d2d2d; padding: 6px; }
        .tarot-card .card-front .card-image { font-size: inherit; margin-bottom: 2px; }
        .tarot-card .card-front .card-name { font-size: 8px; font-weight: 600; text-align: center; line-height: 1.1; }
        .tarot-card .card-front .reversed-mark { position: absolute; top: 4px; right: 4px; font-size: 10px; color: var(--accent-red); }
        .card-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; text-align: center; }
        .control-area { text-align: center; margin-bottom: 20px; }
        .flip-mode-toggle { display: flex; gap: 12px; justify-content: center; margin-bottom: 12px; }
        .flip-mode-toggle label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; color: var(--text-secondary); }
        .flip-mode-toggle input { accent-color: var(--accent-purple); }
        .draw-btn { background: linear-gradient(135deg, var(--accent-purple), #8e44ad); color: white; border: none; padding: 14px 40px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--glow-purple); }
        .draw-btn:active { transform: scale(0.95); }
        .draw-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .flip-hint { color: var(--text-secondary); font-size: 13px; margin-top: 12px; display: none; }
        .result-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 20px; margin-top: 20px; display: none; }
        .result-section.show { display: block; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-header { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; padding-bottom: 14px; border-bottom: 1px solid var(--border-color); }
        .result-card-preview { width: 60px; height: 90px; background: linear-gradient(145deg, #f5f0e1, #e8dcc8); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 28px; color: #2d2d2d; flex-shrink: 0; }
        .result-card-preview .name { font-size: 9px; font-weight: 600; margin-top: 2px; }
        .result-info h3 { font-family: 'Noto Serif TC', serif; font-size: 18px; color: var(--text-gold); margin-bottom: 4px; }
        .result-info .position { font-size: 12px; color: var(--accent-purple); margin-bottom: 6px; }
        .result-info .keywords { display: flex; flex-wrap: wrap; gap: 5px; }
        .keyword { background: rgba(155, 89, 182, 0.2); color: var(--accent-purple); padding: 3px 8px; border-radius: 10px; font-size: 10px; }
        .keyword.reversed { background: rgba(231, 76, 60, 0.2); color: var(--accent-red); }
        .fortune-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 16px 0; }
        .fortune-item { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 10px 6px; text-align: center; }
        .fortune-item .icon { font-size: 20px; margin-bottom: 3px; }
        .fortune-item .label { font-size: 10px; color: var(--text-secondary); margin-bottom: 2px; }
        .fortune-item .score { font-size: 16px; font-weight: 700; }
        .fortune-item .score.high { color: var(--accent-green); }
        .fortune-item .score.mid { color: var(--accent-gold); }
        .fortune-item .score.low { color: var(--accent-red); }
        .ai-reading { background: rgba(155, 89, 182, 0.1); border: 1px solid rgba(155, 89, 182, 0.3); border-radius: 14px; padding: 16px; margin: 16px 0; }
        .ai-reading-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 14px; font-weight: 600; color: var(--accent-purple); }
        .ai-reading-content { font-size: 14px; line-height: 1.7; color: var(--text-primary); }
        .ai-reading-content.loading { color: var(--text-secondary); font-style: italic; }
        .content-block { margin: 14px 0; }
        .content-block h4 { font-size: 13px; color: var(--text-gold); margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
        .content-block p { font-size: 13px; color: var(--text-primary); line-height: 1.6; }
        .action-buttons { display: flex; gap: 10px; margin-top: 16px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
        .action-btn:active { transform: scale(0.95); }
        .action-btn.primary { background: linear-gradient(135deg, #00b900, #00c300); color: white; }
        .action-btn.secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .action-btn.voice { background: linear-gradient(135deg, var(--accent-purple), #8e44ad); color: white; }
        
        /* ===== èªéŸ³æ§åˆ¶æ¨£å¼ ===== */
        .action-btn.voice.playing { background: linear-gradient(135deg, #e74c3c, #c0392b); animation: pulse-btn 1.5s ease-in-out infinite; }
        .action-btn.voice.paused { background: linear-gradient(135deg, #f39c12, #d68910); }
        @keyframes pulse-btn { 0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } }
        .voice-controls { display: flex; gap: 8px; margin-top: 10px; }
        .voice-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; }
        .voice-btn:active { transform: scale(0.95); }
        .voice-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .voice-btn.pause { background: linear-gradient(135deg, #f39c12, #d68910); color: white; }
        .voice-btn.stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .voice-btn.replay { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .voice-status { text-align: center; font-size: 12px; color: var(--text-secondary); margin-top: 8px; min-height: 18px; }
        /* ===== èªéŸ³æ§åˆ¶æ¨£å¼çµæŸ ===== */

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 430px; margin: 0 auto; background: rgba(22, 22, 31, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 10px 16px calc(10px + var(--safe-bottom)); display: flex; justify-content: space-around; border-top: 1px solid var(--border-color); z-index: 100; }
        .nav-item { text-align: center; cursor: pointer; opacity: 0.5; transition: all 0.2s; padding: 6px 12px; }
        .nav-item.active { opacity: 1; }
        .nav-item .icon { font-size: 22px; margin-bottom: 3px; }
        .nav-item .label { font-size: 10px; }
        .page { display: none; }
        .page.active { display: block; }
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 14px; padding: 14px; cursor: pointer; transition: all 0.2s; position: relative; }
        .history-item:active { transform: scale(0.98); }
        .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .history-item-date { font-size: 12px; color: var(--text-secondary); }
        .history-item-spread { font-size: 11px; background: rgba(155, 89, 182, 0.2); color: var(--accent-purple); padding: 3px 8px; border-radius: 8px; }
        .history-item-cards { display: flex; gap: 6px; flex-wrap: wrap; }
        .history-card-mini { font-size: 20px; }
        .history-item-question { font-size: 13px; color: var(--text-secondary); margin-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 40px; }
        .history-delete-btn { position: absolute; bottom: 12px; right: 12px; background: rgba(231, 76, 60, 0.2); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .history-delete-btn:hover { background: rgba(231, 76, 60, 0.4); }
        .history-delete-btn:active { transform: scale(0.9); }
        .history-item-content { padding-right: 40px; }
        .stats-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .stats-card h3 { font-size: 14px; color: var(--text-gold); margin-bottom: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-item { text-align: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; }
        .stat-item .value { font-size: 24px; font-weight: 700; color: var(--accent-purple); }
        .stat-item .label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .top-cards-list { display: flex; flex-direction: column; gap: 8px; }
        .top-card-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; }
        .top-card-item .rank { font-size: 14px; font-weight: 700; color: var(--text-gold); width: 24px; }
        .top-card-item .card-icon { font-size: 24px; }
        .top-card-item .card-name { flex: 1; font-size: 14px; }
        .top-card-item .count { font-size: 14px; color: var(--accent-purple); font-weight: 600; }
        .card-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .card-learn-item { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .card-learn-item:active { transform: scale(0.95); }
        .card-learn-item .icon { font-size: 28px; margin-bottom: 4px; }
        .card-learn-item .name { font-size: 10px; color: var(--text-secondary); }
        .settings-section { margin-bottom: 24px; }
        .settings-section-title { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .settings-card { background: var(--bg-secondary); border-radius: 14px; overflow: hidden; }
        .settings-item { padding: 14px 16px; border-bottom: 1px solid var(--border-color); }
        .settings-item:last-child { border-bottom: none; }
        .settings-item label { display: block; font-size: 14px; margin-bottom: 8px; }
        .settings-item input, .settings-item select { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 12px; color: var(--text-primary); font-size: 14px; }
        .settings-item input:focus, .settings-item select:focus { outline: none; border-color: var(--accent-purple); }
        .settings-toggle { display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { width: 50px; height: 28px; background: var(--bg-tertiary); border-radius: 14px; position: relative; cursor: pointer; transition: background 0.3s; }
        .toggle-switch.active { background: var(--accent-purple); }
        .toggle-switch::after { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: left 0.3s; }
        .toggle-switch.active::after { left: 25px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 20px; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-secondary); border-radius: 20px; width: 100%; max-width: 360px; max-height: 80vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.3s; }
        .modal.show .modal-content { transform: translateY(0); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; color: var(--text-gold); }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; }
        .modal-body { padding: 20px; }
        .toast { position: fixed; bottom: calc(100px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-tertiary); color: var(--text-primary); padding: 12px 24px; border-radius: 25px; font-size: 14px; opacity: 0; transition: all 0.3s ease; z-index: 1100; white-space: nowrap; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state .icon { font-size: 60px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }
    </style>
</head>
<body>
    <div class="splash-screen" id="splashScreen">
        <div class="particles"><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div></div>
        <div class="splash-container">
            <div class="bagua-ring"><span class="bagua-symbol">â˜°</span><span class="bagua-symbol">â˜±</span><span class="bagua-symbol">â˜²</span><span class="bagua-symbol">â˜³</span><span class="bagua-symbol">â˜´</span><span class="bagua-symbol">â˜µ</span><span class="bagua-symbol">â˜¶</span><span class="bagua-symbol">â˜·</span></div>
            <div class="ring-1"></div><div class="ring-2"></div><div class="ring-3"></div>
            <div class="splash-text">å¦</div>
        </div>
        <div class="splash-loading"><div class="splash-title">AI å¡”ç¾…å åœ</div><div class="splash-subtitle">LOADING...</div><div class="progress-bar"><div class="progress-fill"></div></div></div>
    </div>

    <div class="app-container">
        <div class="status-bar"><div class="dynamic-island"></div><span id="statusTime">9:41</span><span>ğŸ”®</span></div>
        <div class="top-toolbar"><button class="toolbar-btn" onclick="toggleSound()" id="sfxBtn">ğŸ”Š</button><button class="toolbar-btn" onclick="toggleBgm()" id="bgmBtn">ğŸµ</button><button class="toolbar-btn" onclick="showPage('settings')">âš™ï¸</button></div>
        
        <div class="main-content">
            <div class="page active" id="page-divine">
                <div class="header"><div class="header-icon">ğŸ”®</div><h1>AI å¡”ç¾…å åœ</h1><p>é¸æ“‡ç‰Œé™£ Â· è¼¸å…¥å•é¡Œ Â· AI è§£è®€</p></div>
                <div class="spread-selector" id="spreadSelector"><button class="spread-btn active" data-spread="single">ğŸ´ å–®ç‰Œ</button><button class="spread-btn" data-spread="yesno">â“ æ˜¯éé¡Œ</button><button class="spread-btn" data-spread="timeline">â³ æ™‚é–“ä¹‹æµ</button><button class="spread-btn" data-spread="love">ğŸ’• æ„›æƒ…</button><button class="spread-btn" data-spread="career">ğŸ’¼ äº‹æ¥­</button><button class="spread-btn" data-spread="daily">â˜€ï¸ æ¯æ—¥</button></div>
                <div class="question-input"><input type="text" id="questionInput" placeholder="è¼¸å…¥ä½ æƒ³å•çš„å•é¡Œï¼ˆé¸å¡«ï¼‰..."></div>
                <div class="tarot-area"><div class="tarot-spread" id="tarotSpread"></div></div>
                <div class="control-area">
                    <div class="flip-mode-toggle"><label><input type="radio" name="flipMode" value="auto" checked> ğŸ¬ è‡ªå‹•ç¿»ç‰Œ</label><label><input type="radio" name="flipMode" value="manual"> ğŸ‘† æ‰‹å‹•ç¿»ç‰Œ</label></div>
                    <button class="draw-btn" id="drawBtn" onclick="startDivine()">ğŸ”® é–‹å§‹å åœ</button>
                    <p class="flip-hint" id="flipHint">ğŸ‘† é»æ“Šå¡ç‰Œç¿»ç‰Œ</p>
                </div>
                <div class="result-section" id="resultSection">
                    <div class="result-header" id="resultHeader"></div>
                    <div class="fortune-grid" id="fortuneGrid">
                        <div class="fortune-item"><div class="icon">â­</div><div class="label">æ•´é«”</div><div class="score high" id="scoreOverall">85</div></div>
                        <div class="fortune-item"><div class="icon">ğŸ’•</div><div class="label">æ„›æƒ…</div><div class="score mid" id="scoreLove">70</div></div>
                        <div class="fortune-item"><div class="icon">ğŸ’¼</div><div class="label">äº‹æ¥­</div><div class="score high" id="scoreCareer">80</div></div>
                        <div class="fortune-item"><div class="icon">ğŸ’°</div><div class="label">è²¡é‹</div><div class="score mid" id="scoreWealth">65</div></div>
                    </div>
                    <div class="ai-reading" id="aiReading"><div class="ai-reading-header"><span>ğŸ¤–</span> AI æ™ºæ…§è§£è®€</div><div class="ai-reading-content" id="aiReadingContent">è¼‰å…¥ä¸­...</div></div>
                    <div class="content-block"><h4>ğŸ“– ç‰Œç¾©è§£è®€</h4><p id="cardMeaning">ç‰Œç¾©å…§å®¹...</p></div>
                    <div class="content-block"><h4>ğŸ’¡ å»ºè­°</h4><p id="cardAdvice">å»ºè­°å…§å®¹...</p></div>
                    
                    <!-- èªéŸ³æ’­æ”¾å€ï¼ˆå·²ä¿®æ”¹æ”¯æ´æš«åœ/åœæ­¢/é‡æ’­ï¼‰-->
                    <div class="action-buttons">
                        <button class="action-btn voice" id="voiceMainBtn" onclick="toggleSpeech()">ğŸ”Š èªéŸ³æ’­å ±</button>
                        <button class="action-btn primary" onclick="sendToLine()">ğŸ“± ç™¼é€ LINE</button>
                    </div>
                    <div class="voice-controls" id="voiceControls" style="display: none;">
                        <button class="voice-btn pause" id="voicePauseBtn" onclick="pauseSpeech()">â¸ï¸ æš«åœ</button>
                        <button class="voice-btn stop" id="voiceStopBtn" onclick="stopSpeech()">â¹ï¸ åœæ­¢</button>
                        <button class="voice-btn replay" id="voiceReplayBtn" onclick="replaySpeech()">ğŸ”„ é‡æ’­</button>
                    </div>
                    <div class="voice-status" id="voiceStatus"></div>
                </div>
            </div>
            
            <div class="page" id="page-history"><div class="header"><div class="header-icon">ğŸ“œ</div><h1>å åœè¨˜éŒ„</h1><p>å›é¡§éå»çš„å åœçµæœ</p></div><div class="history-list" id="historyList"></div></div>
            <div class="page" id="page-stats"><div class="header"><div class="header-icon">ğŸ“Š</div><h1>å åœçµ±è¨ˆ</h1><p>ä½ çš„å¡”ç¾…æ•¸æ“šåˆ†æ</p></div><div class="stats-card"><h3>ğŸ“ˆ ç¸½è¦½</h3><div class="stats-grid"><div class="stat-item"><div class="value" id="statTotal">0</div><div class="label">ç¸½å åœæ¬¡æ•¸</div></div><div class="stat-item"><div class="value" id="statThisWeek">0</div><div class="label">æœ¬é€±æ¬¡æ•¸</div></div><div class="stat-item"><div class="value" id="statAvgScore">--</div><div class="label">å¹³å‡é‹å‹¢</div></div><div class="stat-item"><div class="value" id="statStreak">0</div><div class="label">é€£çºŒå¤©æ•¸</div></div></div></div><div class="stats-card"><h3>ğŸƒ æœ€å¸¸æŠ½åˆ°çš„ç‰Œ</h3><div class="top-cards-list" id="topCardsList"></div></div></div>
            <div class="page" id="page-learn"><div class="header"><div class="header-icon">ğŸ“š</div><h1>ç‰Œç¾©æ•™å­¸</h1><p>èªè­˜ 22 å¼µå¤§é˜¿çˆ¾å…‹é‚£</p></div><div class="card-grid" id="cardGrid"></div></div>
            <div class="page" id="page-settings"><div class="header"><div class="header-icon">âš™ï¸</div><h1>è¨­å®š</h1><p>è‡ªè¨‚ä½ çš„å åœé«”é©—</p></div><div class="settings-section"><div class="settings-section-title">AI è¨­å®š</div><div class="settings-card"><div class="settings-item"><label>Groq API Key</label><input type="password" id="groqApiKey" placeholder="è¼¸å…¥ Groq API Key"></div><div class="settings-item"><label>AI æ¨¡å‹</label><select id="aiModel"><option value="llama-3.3-70b-versatile">Llama 3.3 70B (æ¨è–¦)</option><option value="llama-3.1-8b-instant">Llama 3.1 8B (å¿«é€Ÿ)</option><option value="mixtral-8x7b-32768">Mixtral 8x7B</option></select></div></div></div><div class="settings-section"><div class="settings-section-title">èªéŸ³è¨­å®š</div><div class="settings-card"><div class="settings-item"><label>èªéŸ³æœå‹™</label><select id="voiceService"><option value="web">Web Speech (å…è²»)</option><option value="gemini">Gemini TTS</option><option value="elevenlabs">ElevenLabs</option></select></div><div class="settings-item"><label>Gemini API Key</label><input type="password" id="geminiApiKey" placeholder="è¼¸å…¥ Gemini API Key"></div></div></div><div class="settings-section"><div class="settings-section-title">ğŸµ è‡ªè¨‚éŸ³æ•ˆï¼ˆå°æ£®å¹³ç­‰ï¼‰</div><div class="settings-card"><div class="settings-item"><label>ğŸƒ ç¿»ç‰ŒéŸ³æ•ˆ</label><input type="file" id="customFlipSound" accept="audio/*" onchange="loadCustomSound('flip', this)"><button class="action-btn secondary" onclick="clearCustomSound('flip')" style="margin-top: 8px; padding: 8px;">æ¸…é™¤è‡ªè¨‚éŸ³æ•ˆ</button></div><div class="settings-item"><label>ğŸ”€ æ´—ç‰ŒéŸ³æ•ˆ</label><input type="file" id="customShuffleSound" accept="audio/*" onchange="loadCustomSound('shuffle', this)"><button class="action-btn secondary" onclick="clearCustomSound('shuffle')" style="margin-top: 8px; padding: 8px;">æ¸…é™¤è‡ªè¨‚éŸ³æ•ˆ</button></div><div class="settings-item"><label>âœ¨ çµæœéŸ³æ•ˆ</label><input type="file" id="customMagicSound" accept="audio/*" onchange="loadCustomSound('magic', this)"><button class="action-btn secondary" onclick="clearCustomSound('magic')" style="margin-top: 8px; padding: 8px;">æ¸…é™¤è‡ªè¨‚éŸ³æ•ˆ</button></div><div class="settings-item"><label>ğŸ¶ èƒŒæ™¯éŸ³æ¨‚</label><input type="file" id="customBgm" accept="audio/*" onchange="loadCustomBgm(this)"><button class="action-btn secondary" onclick="clearCustomBgm()" style="margin-top: 8px; padding: 8px;">æ¸…é™¤è‡ªè¨‚èƒŒæ™¯éŸ³æ¨‚</button></div><p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; padding: 0 16px 16px;">ğŸ’¡ å¯å¾<a href="https://taira-komori.jpn.org/freesoundtw.html" target="_blank" style="color: var(--accent-purple);">å°æ£®å¹³å…è²»éŸ³æ•ˆ</a>ä¸‹è¼‰ MP3 å¾Œä¸Šå‚³ä½¿ç”¨</p></div></div><div class="settings-section"><div class="settings-section-title">LINE é€šçŸ¥</div><div class="settings-card"><div class="settings-item"><label>GAS Web App URL</label><input type="text" id="gasUrl" placeholder="https://script.google.com/..."></div></div></div><div class="settings-section"><div class="settings-section-title">å åœè¨­å®š</div><div class="settings-card"><div class="settings-item settings-toggle"><label>å•Ÿç”¨æ­£é€†ä½</label><div class="toggle-switch" id="toggleReversed" onclick="toggleReversedSetting()"></div></div><div class="settings-item settings-toggle"><label>éŸ³æ•ˆ</label><div class="toggle-switch active" id="toggleSfx" onclick="toggleSfxSetting()"></div></div><div class="settings-item settings-toggle"><label>èƒŒæ™¯éŸ³æ¨‚</label><div class="toggle-switch" id="toggleBgm" onclick="toggleBgmSetting()"></div></div></div></div><div class="settings-section"><div class="settings-section-title">è³‡æ–™ç®¡ç†</div><div class="settings-card"><div class="settings-item"><button class="action-btn secondary" onclick="exportData()" style="width: 100%;">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button></div><div class="settings-item"><button class="action-btn secondary" onclick="clearHistory()" style="width: 100%; color: var(--accent-red);">ğŸ—‘ï¸ æ¸…é™¤æ­·å²è¨˜éŒ„</button></div></div></div></div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showPage('divine')"><div class="icon">ğŸ”®</div><div class="label">å åœ</div></div>
            <div class="nav-item" onclick="showPage('history')"><div class="icon">ğŸ“œ</div><div class="label">æ­·å²</div></div>
            <div class="nav-item" onclick="showPage('stats')"><div class="icon">ğŸ“Š</div><div class="label">çµ±è¨ˆ</div></div>
            <div class="nav-item" onclick="showPage('learn')"><div class="icon">ğŸ“š</div><div class="label">å­¸ç¿’</div></div>
        </div>
    </div>
    
    <div class="modal" id="cardDetailModal"><div class="modal-content"><div class="modal-header"><h3 id="modalCardName">æ„šè€…</h3><button class="modal-close" onclick="closeModal('cardDetailModal')">Ã—</button></div><div class="modal-body"><div style="text-align: center; margin-bottom: 16px;"><span style="font-size: 60px;" id="modalCardIcon">ğŸƒ</span><p style="color: var(--text-secondary); font-size: 14px;" id="modalCardEnName">The Fool</p></div><div class="content-block"><h4>ğŸ”‘ é—œéµè©</h4><div id="modalKeywords" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;"></div></div><div class="content-block"><h4>ğŸ“– æ­£ä½ç‰Œç¾©</h4><p id="modalMeaningUpright"></p></div><div class="content-block"><h4>ğŸ”„ é€†ä½ç‰Œç¾©</h4><p id="modalMeaningReversed"></p></div><div class="content-block"><h4>ğŸ’¡ å»ºè­°</h4><p id="modalAdvice"></p></div></div></div></div>
    
    <!-- æ­·å²è©³æƒ… Modal -->
    <div class="modal" id="historyDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="historyModalTitle">ğŸ“œ å åœè¨˜éŒ„</h3>
                <button class="modal-close" onclick="closeModal('historyDetailModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="historyModalDate" style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;"></div>
                <div id="historyModalCards" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 16px;"></div>
                <div id="historyModalQuestion" style="background: rgba(155, 89, 182, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 16px; display: none;">
                    <div style="font-size: 12px; color: var(--accent-purple); margin-bottom: 4px;">â“ æå•</div>
                    <div id="historyModalQuestionText" style="font-size: 14px;"></div>
                </div>
                <div class="fortune-grid" id="historyModalScores" style="margin-bottom: 16px;"></div>
                <div id="historyModalAiReading" class="ai-reading" style="display: none;">
                    <div class="ai-reading-header"><span>ğŸ¤–</span> AI æ™ºæ…§è§£è®€</div>
                    <div class="ai-reading-content" id="historyModalAiText"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

    <script>
        const tarotDeck = [
            { id: 0, name: 'æ„šè€…', enName: 'The Fool', icon: 'ğŸƒ', keywords: ['æ–°é–‹å§‹', 'å†’éšª', 'ç´”çœŸ', 'è‡ªç”±'], keywordsReversed: ['é­¯è½', 'æ„šè ¢', 'å†’å¤±', 'ä¸æˆç†Ÿ'], meaning: 'æ„šè€…ä»£è¡¨è‘—æ–°çš„é–‹å§‹å’Œç„¡é™çš„å¯èƒ½æ€§ã€‚å®ƒè±¡å¾µè‘—å‹‡æ–¼å†’éšªã€ä¿æŒç´”çœŸçš„å¿ƒæ…‹ï¼Œä»¥åŠå°æœªçŸ¥ä¸–ç•Œçš„å¥½å¥‡èˆ‡æ¢ç´¢ã€‚', meaningReversed: 'é€†ä½çš„æ„šè€…æš—ç¤ºè‘—é­¯è½è¡Œäº‹ã€ç¼ºä¹è¨ˆåŠƒï¼Œæˆ–è€…å°é¢¨éšªè¦–è€Œä¸è¦‹ã€‚', advice: 'ä¿æŒé–‹æ”¾çš„å¿ƒæ…‹ï¼Œå‹‡æ–¼å˜—è©¦æ–°äº‹ç‰©ï¼Œä½†ä¹Ÿè¦é©åº¦è©•ä¼°é¢¨éšªã€‚' },
            { id: 1, name: 'é­”è¡“å¸«', enName: 'The Magician', icon: 'ğŸ©', keywords: ['å‰µé€ åŠ›', 'æ„å¿—åŠ›', 'æŠ€èƒ½', 'è¡Œå‹•'], keywordsReversed: ['æ¬ºé¨™', 'æ“æ§', 'æ‰èƒ½æµªè²»', 'ç¼ºä¹æ–¹å‘'], meaning: 'é­”è¡“å¸«ä»£è¡¨è‘—å¼·å¤§çš„å‰µé€ åŠ›å’Œè¡Œå‹•åŠ›ã€‚ä½ æ“æœ‰å°‡æƒ³æ³•åŒ–ç‚ºç¾å¯¦çš„èƒ½åŠ›ï¼Œæ‰€æœ‰è³‡æºéƒ½å·²é½Šå‚™ã€‚', meaningReversed: 'é€†ä½çš„é­”è¡“å¸«å¯èƒ½æš—ç¤ºæ¬ºé¨™ã€æ“æ§ï¼Œæˆ–è€…æ‰èƒ½æœªè¢«å–„ç”¨ã€‚', advice: 'å–„ç”¨ä½ çš„æŠ€èƒ½å’Œè³‡æºï¼Œä¸»å‹•å‡ºæ“Šæœƒæœ‰å¥½çµæœã€‚' },
            { id: 2, name: 'å¥³ç¥­å¸', enName: 'The High Priestess', icon: 'ğŸŒ™', keywords: ['ç›´è¦º', 'ç¥ç§˜', 'æ™ºæ…§', 'æ½›æ„è­˜'], keywordsReversed: ['å£“æŠ‘ç›´è¦º', 'ç§˜å¯†', 'è¡¨é¢', 'æ··äº‚'], meaning: 'å¥³ç¥­å¸ä»£è¡¨è‘—æ·±å±¤çš„ç›´è¦ºå’Œå…§åœ¨æ™ºæ…§ã€‚å¥¹æé†’ä½ å‚¾è½å…§å¿ƒçš„è²éŸ³ã€‚', meaningReversed: 'é€†ä½çš„å¥³ç¥­å¸æš—ç¤ºå¿½ç•¥å…§å¿ƒè²éŸ³ã€éæ–¼ä¾è³´è¡¨é¢è³‡è¨Šã€‚', advice: 'éœä¸‹å¿ƒä¾†å‚¾è½å…§å¿ƒçš„æŒ‡å¼•ï¼Œç­”æ¡ˆå°±åœ¨ä½ å¿ƒä¸­ã€‚' },
            { id: 3, name: 'å¥³çš‡', enName: 'The Empress', icon: 'ğŸ‘‘', keywords: ['è±ç››', 'æ¯æ€§', 'å‰µé€ ', 'ç¾éº—'], keywordsReversed: ['ä¾è³´', 'ç©ºè™›', 'å‰µé€ åŠ›é˜»å¡', 'å¿½è¦–è‡ªæˆ‘'], meaning: 'å¥³çš‡ä»£è¡¨è‘—è±ç››èˆ‡å‰µé€ åŠ›ã€‚å¥¹è±¡å¾µè‘—ç”Ÿå‘½çš„æ»‹é¤Šã€ç‰©è³ªçš„å¯Œè¶³ã€‚', meaningReversed: 'é€†ä½çš„å¥³çš‡å¯èƒ½è¡¨ç¤ºéåº¦ä¾è³´ã€å‰µé€ åŠ›å—é˜»ã€‚', advice: 'äº«å—ç”Ÿæ´»ä¸­çš„ç¾å¥½äº‹ç‰©ï¼Œé—œæ„›èº«é‚Šçš„äººã€‚' },
            { id: 4, name: 'çš‡å¸', enName: 'The Emperor', icon: 'ğŸ°', keywords: ['æ¬Šå¨', 'ç©©å®š', 'é ˜å°', 'ä¿è­·'], keywordsReversed: ['å°ˆåˆ¶', 'åƒµåŒ–', 'æ§åˆ¶æ…¾', 'ä¸æˆç†Ÿ'], meaning: 'çš‡å¸ä»£è¡¨è‘—æ¬Šå¨å’Œç©©å®šçš„åŠ›é‡ã€‚ä»–è±¡å¾µè‘—ç†æ€§æ€ç¶­ã€ç´€å¾‹å’Œå»ºç«‹ç§©åºçš„èƒ½åŠ›ã€‚', meaningReversed: 'é€†ä½çš„çš‡å¸å¯èƒ½æš—ç¤ºéåº¦æ§åˆ¶ã€åƒµåŒ–æ€ç¶­ã€‚', advice: 'å±•ç¾ä½ çš„é ˜å°æ‰èƒ½ï¼Œåˆ¶å®šæ˜ç¢ºçš„è¨ˆåŠƒã€‚' },
            { id: 5, name: 'æ•™çš‡', enName: 'The Hierophant', icon: 'â›ª', keywords: ['å‚³çµ±', 'æŒ‡å°', 'ä¿¡ä»°', 'æ•™è‚²'], keywordsReversed: ['æ‰“ç ´å‚³çµ±', 'å€‹äººä¿¡å¿µ', 'åå›', 'æ–°æ–¹æ³•'], meaning: 'æ•™çš‡ä»£è¡¨è‘—å‚³çµ±åƒ¹å€¼å’Œç²¾ç¥æŒ‡å°ã€‚ä»–æé†’æˆ‘å€‘å°Šé‡å‚³çµ±æ™ºæ…§ã€‚', meaningReversed: 'é€†ä½çš„æ•™çš‡å¯èƒ½æš—ç¤ºéœ€è¦æ‰“ç ´å¸¸è¦ã€å»ºç«‹å€‹äººä¿¡å¿µã€‚', advice: 'å‘æœ‰ç¶“é©—çš„äººè«‹æ•™ï¼Œéµå¾ªæ­£ç¢ºçš„æ–¹æ³•å’Œç¨‹åºã€‚' },
            { id: 6, name: 'æˆ€äºº', enName: 'The Lovers', icon: 'ğŸ’•', keywords: ['æ„›æƒ…', 'é¸æ“‡', 'å’Œè«§', 'åƒ¹å€¼è§€'], keywordsReversed: ['ä¸å’Œè«§', 'åƒ¹å€¼è¡çª', 'éŒ¯èª¤é¸æ“‡', 'ä¸å¹³è¡¡'], meaning: 'æˆ€äººç‰Œä»£è¡¨è‘—æ„›æƒ…å’Œé‡è¦çš„é¸æ“‡ã€‚å®ƒè±¡å¾µè‘—å…§å¿ƒåƒ¹å€¼è§€çš„çµ±ä¸€ã€‚', meaningReversed: 'é€†ä½çš„æˆ€äººå¯èƒ½æš—ç¤ºé—œä¿‚ä¸å’Œè«§ã€åƒ¹å€¼è§€è¡çªã€‚', advice: 'å‚¾è½ä½ çš„å¿ƒï¼Œåšå‡ºç¬¦åˆåƒ¹å€¼è§€çš„é¸æ“‡ã€‚' },
            { id: 7, name: 'æˆ°è»Š', enName: 'The Chariot', icon: 'ğŸï¸', keywords: ['å‹åˆ©', 'æ„å¿—', 'æ±ºå¿ƒ', 'æ§åˆ¶'], keywordsReversed: ['å¤±æ§', 'ä¾µç•¥', 'ç¼ºä¹æ–¹å‘', 'æŒ«æ•—'], meaning: 'æˆ°è»Šä»£è¡¨è‘—å‹åˆ©å’Œå‰é€²çš„å‹•åŠ›ã€‚å®ƒè±¡å¾µè‘—å…‹æœéšœç¤™çš„æ±ºå¿ƒã€‚', meaningReversed: 'é€†ä½çš„æˆ°è»Šå¯èƒ½æš—ç¤ºå¤±å»æ§åˆ¶ã€æ–¹å‘è¿·å¤±ã€‚', advice: 'ä¿æŒå°ˆæ³¨å’Œæ±ºå¿ƒï¼Œç©æ¥µæ¡å–è¡Œå‹•ã€‚' },
            { id: 8, name: 'åŠ›é‡', enName: 'Strength', icon: 'ğŸ¦', keywords: ['å‹‡æ°£', 'è€å¿ƒ', 'å…§åœ¨åŠ›é‡', 'æ…ˆæ‚²'], keywordsReversed: ['è‡ªæˆ‘æ‡·ç–‘', 'è»Ÿå¼±', 'ç¼ºä¹è‡ªä¿¡', 'æ¿«ç”¨åŠ›é‡'], meaning: 'åŠ›é‡ç‰Œä»£è¡¨è‘—å…§åœ¨çš„å‹‡æ°£å’Œè€å¿ƒã€‚çœŸæ­£çš„åŠ›é‡ä¾†è‡ªæ–¼æº«æŸ”å’Œè‡ªæˆ‘æ§åˆ¶ã€‚', meaningReversed: 'é€†ä½çš„åŠ›é‡æš—ç¤ºè‡ªæˆ‘æ‡·ç–‘ã€ç¼ºä¹ä¿¡å¿ƒã€‚', advice: 'ä»¥æŸ”å…‹å‰›ï¼Œç”¨è€å¿ƒå’Œæ„›å¿ƒé¢å°æŒ‘æˆ°ã€‚' },
            { id: 9, name: 'éš±å£«', enName: 'The Hermit', icon: 'ğŸ”ï¸', keywords: ['å…§çœ', 'æ™ºæ…§', 'ç¨è™•', 'å°‹æ‰¾'], keywordsReversed: ['å­¤ç«‹', 'é€ƒé¿', 'æ‹’çµ•å¹«åŠ©', 'è¿·å¤±'], meaning: 'éš±å£«ä»£è¡¨è‘—å…§åœ¨çš„æ¢ç´¢å’Œæ™ºæ…§çš„è¿½å°‹ã€‚ä»–æé†’æˆ‘å€‘æœ‰æ™‚éœ€è¦ç¨è™•ä¾†æ‰¾åˆ°äººç”Ÿçš„ç­”æ¡ˆã€‚', meaningReversed: 'é€†ä½çš„éš±å£«å¯èƒ½æš—ç¤ºéåº¦å­¤ç«‹ã€é€ƒé¿ç¾å¯¦ã€‚', advice: 'çµ¦è‡ªå·±ä¸€äº›ç¨è™•çš„æ™‚é–“ï¼Œåæ€å’Œæ²‰æ¾±ã€‚' },
            { id: 10, name: 'å‘½é‹ä¹‹è¼ª', enName: 'Wheel of Fortune', icon: 'ğŸ¡', keywords: ['è½‰è®Š', 'æ©Ÿæœƒ', 'å‘½é‹', 'é€±æœŸ'], keywordsReversed: ['å£é‹', 'æŠ—æ‹’æ”¹è®Š', 'å¤±æ§', 'å»¶é²'], meaning: 'å‘½é‹ä¹‹è¼ªä»£è¡¨è‘—ç”Ÿå‘½çš„å¾ªç’°å’Œè½‰è®Šã€‚å®ƒæé†’æˆ‘å€‘ä¸–äº‹ç„¡å¸¸ã€‚', meaningReversed: 'é€†ä½çš„å‘½é‹ä¹‹è¼ªå¯èƒ½æš—ç¤ºé‹æ°£ä¸ä½³ã€æŠ—æ‹’å¿…è¦çš„æ”¹è®Šã€‚', advice: 'æŠŠæ¡ç•¶ä¸‹çš„æ©Ÿæœƒï¼Œé †æ‡‰è®ŠåŒ–çš„æ½®æµã€‚' },
            { id: 11, name: 'æ­£ç¾©', enName: 'Justice', icon: 'âš–ï¸', keywords: ['å…¬å¹³', 'çœŸç›¸', 'å› æœ', 'æ±ºæ–·'], keywordsReversed: ['ä¸å…¬å¹³', 'é€ƒé¿è²¬ä»»', 'åè¦‹', 'æ¬ºé¨™'], meaning: 'æ­£ç¾©ç‰Œä»£è¡¨è‘—å…¬å¹³å’ŒçœŸç›¸ã€‚å®ƒæé†’æˆ‘å€‘æ¯å€‹è¡Œç‚ºéƒ½æœ‰å¾Œæœã€‚', meaningReversed: 'é€†ä½çš„æ­£ç¾©æš—ç¤ºä¸å…¬å¹³çš„å°å¾…ã€é€ƒé¿è²¬ä»»ã€‚', advice: 'èª å¯¦é¢å°è‡ªå·±å’Œä»–äººï¼Œåšå‡ºå…¬æ­£çš„æ±ºå®šã€‚' },
            { id: 12, name: 'å€’åŠäºº', enName: 'The Hanged Man', icon: 'ğŸ™ƒ', keywords: ['çŠ§ç‰²', 'ç­‰å¾…', 'æ–°è¦–è§’', 'æ”¾ä¸‹'], keywordsReversed: ['æ‹–å»¶', 'æŠ—æ‹’', 'ç„¡æ„ç¾©çŠ§ç‰²', 'åƒµå±€'], meaning: 'å€’åŠäººä»£è¡¨è‘—æš«åœå’Œæ›å€‹è§’åº¦çœ‹å•é¡Œã€‚æœ‰æ™‚å€™æ”¾æ‰‹å’Œç­‰å¾…æœƒå¸¶ä¾†æ„æƒ³ä¸åˆ°çš„æ”¶ç©«ã€‚', meaningReversed: 'é€†ä½çš„å€’åŠäººå¯èƒ½æš—ç¤ºç„¡æ„ç¾©çš„æ‹–å»¶ã€æŠ—æ‹’å¿…è¦çš„æ”¹è®Šã€‚', advice: 'å˜—è©¦ç”¨ä¸åŒçš„è§’åº¦çœ‹å¾…å•é¡Œï¼Œæœ‰æ™‚å€™ç­‰å¾…ä¹Ÿæ˜¯ä¸€ç¨®æ™ºæ…§ã€‚' },
            { id: 13, name: 'æ­»ç¥', enName: 'Death', icon: 'ğŸ¦‹', keywords: ['çµæŸ', 'è½‰è®Š', 'é‡ç”Ÿ', 'æ”¾ä¸‹éå»'], keywordsReversed: ['æŠ—æ‹’æ”¹è®Š', 'åœæ»¯', 'ç„¡æ³•æ”¾æ‰‹', 'ææ‡¼'], meaning: 'æ­»ç¥ç‰Œä»£è¡¨è‘—çµæŸå’Œè½‰è®Šã€‚å®ƒè±¡å¾µè‘—èˆŠäº‹ç‰©çš„çµ‚çµï¼Œç‚ºæ–°çš„é–‹å§‹æ¸…å‡ºç©ºé–“ã€‚', meaningReversed: 'é€†ä½çš„æ­»ç¥æš—ç¤ºæŠ—æ‹’å¿…è¦çš„æ”¹è®Šã€ç„¡æ³•æ”¾ä¸‹éå»ã€‚', advice: 'æ”¾ä¸‹ä¸å†éœ€è¦çš„äº‹ç‰©ï¼Œæ“æŠ±æ”¹è®Šã€‚æ¯å€‹çµæŸéƒ½æ˜¯æ–°çš„é–‹å§‹ã€‚' },
            { id: 14, name: 'ç¯€åˆ¶', enName: 'Temperance', icon: 'ğŸº', keywords: ['å¹³è¡¡', 'èª¿å’Œ', 'è€å¿ƒ', 'é©åº¦'], keywordsReversed: ['å¤±è¡¡', 'éåº¦', 'ç¼ºä¹è€å¿ƒ', 'è¡çª'], meaning: 'ç¯€åˆ¶ä»£è¡¨è‘—å¹³è¡¡å’Œèª¿å’Œã€‚å®ƒæé†’æˆ‘å€‘åœ¨ç”Ÿæ´»ä¸­ä¿æŒä¸­åº¸ä¹‹é“ï¼Œé¿å…æ¥µç«¯ã€‚', meaningReversed: 'é€†ä½çš„ç¯€åˆ¶æš—ç¤ºç”Ÿæ´»å¤±è¡¡ã€éåº¦ç¸±æ…¾ï¼Œæˆ–ç¼ºä¹è€å¿ƒã€‚', advice: 'ä¿æŒå¹³è¡¡çš„ç”Ÿæ´»æ–¹å¼ï¼Œä¸è¦æ“ä¹‹éæ€¥ã€‚' },
            { id: 15, name: 'æƒ¡é­”', enName: 'The Devil', icon: 'ğŸ˜ˆ', keywords: ['æŸç¸›', 'èª˜æƒ‘', 'æ…¾æœ›', 'é™°å½±'], keywordsReversed: ['è§£è„«', 'è¦ºé†’', 'æ‰“ç ´æŸç¸›', 'æ¢å¾©åŠ›é‡'], meaning: 'æƒ¡é­”ç‰Œä»£è¡¨è‘—å…§å¿ƒçš„æŸç¸›å’Œèª˜æƒ‘ã€‚å®ƒæé†’æˆ‘å€‘æ­£è¦–è‡ªå·±çš„é™°æš—é¢ã€‚', meaningReversed: 'é€†ä½çš„æƒ¡é­”æš—ç¤ºæ­£åœ¨æ™è„«æŸç¸›ã€è¦ºé†’ä¸­ã€‚', advice: 'æª¢è¦–ä»€éº¼åœ¨æŸç¸›ä½ ï¼Œæ˜¯æ™‚å€™æ‰“ç ´ä¸å¥åº·çš„æ¨¡å¼äº†ã€‚' },
            { id: 16, name: 'é«˜å¡”', enName: 'The Tower', icon: 'ğŸ—¼', keywords: ['çªè®Š', 'è¦ºé†’', 'è§£æ”¾', 'çœŸç›¸'], keywordsReversed: ['é€ƒé¿ç½é›£', 'ææ‡¼æ”¹è®Š', 'å»¶é²å´©å¡Œ', 'å€‹äººè½‰è®Š'], meaning: 'é«˜å¡”ä»£è¡¨è‘—çªç„¶çš„è®ŠåŒ–å’ŒèˆŠçµæ§‹çš„å´©å¡Œã€‚é›–ç„¶ä»¤äººä¸å®‰ï¼Œä½†å®ƒç‚ºé‡å»ºå¸¶ä¾†æ©Ÿæœƒã€‚', meaningReversed: 'é€†ä½çš„é«˜å¡”å¯èƒ½æš—ç¤ºæ­£åœ¨é¿å…ç½é›£ã€ææ‡¼å¿…è¦çš„æ”¹è®Šã€‚', advice: 'æº–å‚™è¿æ¥è®ŠåŒ–ï¼Œæœ‰äº›äº‹æƒ…éœ€è¦è¢«æ‰“ç ´æ‰èƒ½é‡å»ºå¾—æ›´å¥½ã€‚' },
            { id: 17, name: 'æ˜Ÿæ˜Ÿ', enName: 'The Star', icon: 'â­', keywords: ['å¸Œæœ›', 'éˆæ„Ÿ', 'å¹³éœ', 'ä¿¡å¿ƒ'], keywordsReversed: ['çµ•æœ›', 'ç¼ºä¹ä¿¡å¿ƒ', 'å¤±å»æ–¹å‘', 'å‰µæ„é˜»å¡'], meaning: 'æ˜Ÿæ˜Ÿä»£è¡¨è‘—å¸Œæœ›å’Œéˆæ„Ÿã€‚å®ƒè±¡å¾µè‘—å›°é›£éå¾Œçš„å¹³éœï¼Œä»¥åŠå°ç¾å¥½æœªä¾†çš„ä¿¡å¿ƒã€‚', meaningReversed: 'é€†ä½çš„æ˜Ÿæ˜Ÿæš—ç¤ºå¤±å»å¸Œæœ›ã€ç¼ºä¹ä¿¡å¿ƒï¼Œæˆ–æ„Ÿåˆ°è¿·å¤±ã€‚', advice: 'ä¿æŒå¸Œæœ›å’Œä¿¡å¿ƒï¼Œç¾å¥½çš„äº‹ç‰©æ­£åœ¨å‘ä½ é è¿‘ã€‚' },
            { id: 18, name: 'æœˆäº®', enName: 'The Moon', icon: 'ğŸŒ•', keywords: ['å¹»è¦º', 'æ½›æ„è­˜', 'ææ‡¼', 'ç›´è¦º'], keywordsReversed: ['èµ°å‡ºææ‡¼', 'çœŸç›¸æ­éœ²', 'é‡‹æ”¾ç„¦æ…®', 'æ¸…æ™°'], meaning: 'æœˆäº®ä»£è¡¨è‘—æ½›æ„è­˜å’Œç›´è¦ºã€‚å®ƒæé†’æˆ‘å€‘é—œæ³¨å¤¢å¢ƒå’Œå…§å¿ƒæ·±è™•çš„æ„Ÿå—ã€‚', meaningReversed: 'é€†ä½çš„æœˆäº®æš—ç¤ºèµ°å‡ºææ‡¼ã€çœŸç›¸é€æ¼¸æ¸…æ™°ã€‚', advice: 'ä¿¡ä»»ä½ çš„ç›´è¦ºï¼Œä½†ä¹Ÿè¦åˆ†è¾¨å¹»è¦ºå’Œç¾å¯¦ã€‚' },
            { id: 19, name: 'å¤ªé™½', enName: 'The Sun', icon: 'â˜€ï¸', keywords: ['æˆåŠŸ', 'å–œæ‚…', 'æ´»åŠ›', 'å…‰æ˜'], keywordsReversed: ['æš«æ™‚æŒ«æŠ˜', 'éåº¦æ¨‚è§€', 'å»¶é²çš„æˆåŠŸ', 'å°‹æ‰¾å¿«æ¨‚'], meaning: 'å¤ªé™½æ˜¯æœ€æ­£é¢çš„ç‰Œä¹‹ä¸€ï¼Œä»£è¡¨è‘—æˆåŠŸã€å–œæ‚…å’Œå……æ²›çš„èƒ½é‡ã€‚ä¸€åˆ‡éƒ½æœƒè®Šå¾—å…‰æ˜ã€‚', meaningReversed: 'é€†ä½çš„å¤ªé™½æš—ç¤ºæš«æ™‚çš„æŒ«æŠ˜ã€éåº¦æ¨‚è§€ã€‚', advice: 'å……æ»¿è‡ªä¿¡åœ°å‰é€²ï¼ä»Šå¤©æ˜¯å……æ»¿èƒ½é‡å’Œæ­£å‘ç™¼å±•çš„ä¸€å¤©ã€‚' },
            { id: 20, name: 'å¯©åˆ¤', enName: 'Judgement', icon: 'ğŸ“¯', keywords: ['è¦ºé†’', 'æ›´æ–°', 'å¬å–š', 'åæ€'], keywordsReversed: ['è‡ªæˆ‘æ‡·ç–‘', 'æ‹’çµ•åçœ', 'éŒ¯éæ©Ÿæœƒ', 'å…§ç–š'], meaning: 'å¯©åˆ¤ä»£è¡¨è‘—è¦ºé†’å’Œé‡ç”Ÿçš„å¬å–šã€‚å®ƒæé†’æˆ‘å€‘åæ€éå»ï¼Œæº–å‚™è¿æ¥æ–°çš„äººç”Ÿéšæ®µã€‚', meaningReversed: 'é€†ä½çš„å¯©åˆ¤æš—ç¤ºè‡ªæˆ‘æ‡·ç–‘ã€æ‹’çµ•åçœéå»ã€‚', advice: 'å‚¾è½å…§å¿ƒçš„å¬å–šï¼Œåšå‡ºé‡è¦çš„äººç”Ÿæ±ºå®šã€‚' },
            { id: 21, name: 'ä¸–ç•Œ', enName: 'The World', icon: 'ğŸŒ', keywords: ['å®Œæˆ', 'åœ“æ»¿', 'æˆå°±', 'æ•´åˆ'], keywordsReversed: ['æœªå®Œæˆ', 'ç¼ºä¹çµå±€', 'å»¶é²', 'ç©ºè™›'], meaning: 'ä¸–ç•Œæ˜¯å¤§é˜¿çˆ¾å…‹é‚£çš„æœ€å¾Œä¸€å¼µç‰Œï¼Œä»£è¡¨è‘—ä¸€å€‹é€±æœŸçš„å®Œæˆå’Œåœ“æ»¿ã€‚ä½ å·²ç¶“é”æˆäº†ç›®æ¨™ã€‚', meaningReversed: 'é€†ä½çš„ä¸–ç•Œæš—ç¤ºäº‹æƒ…å°šæœªå®Œæˆã€ç¼ºä¹åœ“æ»¿æ„Ÿã€‚', advice: 'æ…¶ç¥ä½ çš„æˆå°±ï¼ä¸€å€‹éšæ®µå·²ç¶“åœ“æ»¿å®Œæˆï¼Œæ–°çš„æ—…ç¨‹å³å°‡å±•é–‹ã€‚' }
        ];
        const spreads = { single: { name: 'å–®ç‰Œå åœ', cards: 1, positions: ['æŒ‡å¼•'] }, yesno: { name: 'æ˜¯éé¡Œå åœ', cards: 1, positions: ['ç­”æ¡ˆ'] }, timeline: { name: 'æ™‚é–“ä¹‹æµ', cards: 3, positions: ['éå»', 'ç¾åœ¨', 'æœªä¾†'] }, love: { name: 'æ„›æƒ…ç‰Œé™£', cards: 4, positions: ['ä½ çš„ç‹€æ…‹', 'å°æ–¹ç‹€æ…‹', 'é—œä¿‚ç¾æ³', 'å»ºè­°'] }, career: { name: 'äº‹æ¥­ç‰Œé™£', cards: 4, positions: ['ç¾æ³', 'æŒ‘æˆ°', 'å»ºè­°', 'çµæœ'] }, daily: { name: 'æ¯æ—¥é‹å‹¢', cards: 3, positions: ['ä»Šæ—¥ä¸»é¡Œ', 'æ³¨æ„äº‹é …', 'å¹¸é‹æŒ‡å¼•'] } };
        let settings = { groqApiKey: '', aiModel: 'llama-3.3-70b-versatile', voiceService: 'web', geminiApiKey: '', gasUrl: '', enableReversed: false, enableSfx: true, enableBgm: false };
        let currentSpread = 'single', selectedCards = [], flippedCount = 0, canFlip = false, currentResult = null, history = [];
        
        // ===== èªéŸ³æ’­æ”¾ç‹€æ…‹ =====
        let speechUtterance = null;
        let speechState = 'stopped'; // stopped, playing, paused
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings(); loadHistory(); loadSavedCustomSounds(); initSpreadSelector(); initCardGrid(); updateStatusTime(); setInterval(updateStatusTime, 1000);
            if ('speechSynthesis' in window) { speechSynthesis.getVoices(); speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices(); }
            setTimeout(() => { document.getElementById('splashScreen').classList.add('fade-out'); setTimeout(() => { document.getElementById('splashScreen').style.display = 'none'; if (settings.enableBgm) startBgm(); }, 800); }, 2500);
            setupSpread(currentSpread);
        });
        
        function updateStatusTime() { const now = new Date(); document.getElementById('statusTime').textContent = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`; }
        function loadSettings() { const saved = localStorage.getItem('tarotProSettings'); if (saved) settings = { ...settings, ...JSON.parse(saved) }; document.getElementById('groqApiKey').value = settings.groqApiKey || ''; document.getElementById('aiModel').value = settings.aiModel || 'llama-3.3-70b-versatile'; document.getElementById('voiceService').value = settings.voiceService || 'web'; document.getElementById('geminiApiKey').value = settings.geminiApiKey || ''; document.getElementById('gasUrl').value = settings.gasUrl || ''; if (settings.enableReversed) document.getElementById('toggleReversed').classList.add('active'); if (settings.enableSfx) document.getElementById('toggleSfx').classList.add('active'); if (settings.enableBgm) document.getElementById('toggleBgm').classList.add('active'); }
        function saveSettings() { settings.groqApiKey = document.getElementById('groqApiKey').value.trim(); settings.aiModel = document.getElementById('aiModel').value; settings.voiceService = document.getElementById('voiceService').value; settings.geminiApiKey = document.getElementById('geminiApiKey').value.trim(); settings.gasUrl = document.getElementById('gasUrl').value.trim(); localStorage.setItem('tarotProSettings', JSON.stringify(settings)); }
        function toggleReversedSetting() { settings.enableReversed = !settings.enableReversed; document.getElementById('toggleReversed').classList.toggle('active'); saveSettings(); }
        function toggleSfxSetting() { settings.enableSfx = !settings.enableSfx; document.getElementById('toggleSfx').classList.toggle('active'); saveSettings(); }
        function toggleBgmSetting() { settings.enableBgm = !settings.enableBgm; document.getElementById('toggleBgm').classList.toggle('active'); if (settings.enableBgm) { startBgm(); } else { stopBgm(); } saveSettings(); }
        function loadHistory() { const saved = localStorage.getItem('tarotProHistory'); if (saved) history = JSON.parse(saved); updateHistoryList(); updateStats(); }
        function saveHistory() { localStorage.setItem('tarotProHistory', JSON.stringify(history)); updateHistoryList(); updateStats(); }
        function addToHistory(result) { history.unshift({ id: Date.now(), date: new Date().toISOString(), spread: currentSpread, question: document.getElementById('questionInput').value || '', cards: result.cards, scores: result.scores, aiReading: result.aiReading || '' }); if (history.length > 100) history = history.slice(0, 100); saveHistory(); }
        function updateHistoryList() { const container = document.getElementById('historyList'); if (history.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“œ</div><p>é‚„æ²’æœ‰å åœè¨˜éŒ„</p></div>'; return; } container.innerHTML = history.slice(0, 50).map((item, index) => { const date = new Date(item.date); const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`; return `<div class="history-item" onclick="showHistoryDetail(${index})"><div class="history-item-content"><div class="history-item-header"><span class="history-item-date">${dateStr}</span><span class="history-item-spread">${spreads[item.spread]?.name || item.spread}</span></div><div class="history-item-cards">${item.cards.map(c => `<span class="history-card-mini">${c.icon}</span>`).join('')}</div>${item.question ? `<div class="history-item-question">${item.question}</div>` : ''}</div><button class="history-delete-btn" onclick="event.stopPropagation(); deleteHistoryItem(${index})">ğŸ—‘ï¸</button></div>`; }).join(''); }
        function clearHistory() { if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) { history = []; saveHistory(); showToast('ğŸ—‘ï¸ æ­·å²è¨˜éŒ„å·²æ¸…é™¤'); } }
        function deleteHistoryItem(index) { if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) { history.splice(index, 1); saveHistory(); showToast('ğŸ—‘ï¸ å·²åˆªé™¤è¨˜éŒ„'); } }
        function showHistoryDetail(index) { const item = history[index]; if (!item) return; const date = new Date(item.date); const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`; document.getElementById('historyModalTitle').textContent = spreads[item.spread]?.name || 'å åœè¨˜éŒ„'; document.getElementById('historyModalDate').textContent = `ğŸ“… ${dateStr}`; document.getElementById('historyModalCards').innerHTML = item.cards.map((card, i) => `<div style="text-align: center;"><div style="width: 60px; height: 85px; background: linear-gradient(145deg, #f5f0e1, #e8dcc8); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #2d2d2d;${card.isReversed ? ' transform: rotate(180deg);' : ''}"><span style="font-size: 28px;">${card.icon}</span><span style="font-size: 9px; font-weight: 600;">${card.name}</span></div><div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">${spreads[item.spread]?.positions[i] || ''}${card.isReversed ? ' (é€†)' : ''}</div></div>`).join(''); const questionContainer = document.getElementById('historyModalQuestion'); if (item.question) { questionContainer.style.display = 'block'; document.getElementById('historyModalQuestionText').textContent = item.question; } else { questionContainer.style.display = 'none'; } if (item.scores) { document.getElementById('historyModalScores').innerHTML = `<div class="fortune-item"><div class="icon">â­</div><div class="label">æ•´é«”</div><div class="score ${item.scores.overall >= 75 ? 'high' : item.scores.overall >= 50 ? 'mid' : 'low'}">${item.scores.overall}</div></div><div class="fortune-item"><div class="icon">ğŸ’•</div><div class="label">æ„›æƒ…</div><div class="score ${item.scores.love >= 75 ? 'high' : item.scores.love >= 50 ? 'mid' : 'low'}">${item.scores.love}</div></div><div class="fortune-item"><div class="icon">ğŸ’¼</div><div class="label">äº‹æ¥­</div><div class="score ${item.scores.career >= 75 ? 'high' : item.scores.career >= 50 ? 'mid' : 'low'}">${item.scores.career}</div></div><div class="fortune-item"><div class="icon">ğŸ’°</div><div class="label">è²¡é‹</div><div class="score ${item.scores.wealth >= 75 ? 'high' : item.scores.wealth >= 50 ? 'mid' : 'low'}">${item.scores.wealth}</div></div>`; } const aiReadingContainer = document.getElementById('historyModalAiReading'); if (item.aiReading) { aiReadingContainer.style.display = 'block'; document.getElementById('historyModalAiText').textContent = item.aiReading; } else { aiReadingContainer.style.display = 'none'; } showModal('historyDetailModal'); }
        function updateStats() { const total = history.length; const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7); const thisWeek = history.filter(h => new Date(h.date) > weekAgo).length; let avgScore = '--'; if (history.length > 0) { const scores = history.filter(h => h.scores).map(h => h.scores.overall); if (scores.length > 0) avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length); } let streak = 0; const dates = [...new Set(history.map(h => new Date(h.date).toDateString()))]; for (let i = 0; i < dates.length; i++) { const checkDate = new Date(); checkDate.setDate(checkDate.getDate() - i); if (dates.includes(checkDate.toDateString())) streak++; else break; } document.getElementById('statTotal').textContent = total; document.getElementById('statThisWeek').textContent = thisWeek; document.getElementById('statAvgScore').textContent = avgScore; document.getElementById('statStreak').textContent = streak; const cardCounts = {}; history.forEach(h => { h.cards.forEach(c => { cardCounts[c.name] = (cardCounts[c.name] || 0) + 1; }); }); const topCards = Object.entries(cardCounts).sort((a, b) => b[1] - a[1]).slice(0, 5); const topCardsContainer = document.getElementById('topCardsList'); if (topCards.length === 0) { topCardsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">é‚„æ²’æœ‰è¶³å¤ çš„è³‡æ–™</p>'; } else { topCardsContainer.innerHTML = topCards.map((item, index) => { const card = tarotDeck.find(c => c.name === item[0]); return `<div class="top-card-item"><span class="rank">#${index + 1}</span><span class="card-icon">${card?.icon || 'ğŸƒ'}</span><span class="card-name">${item[0]}</span><span class="count">${item[1]}æ¬¡</span></div>`; }).join(''); } }
        function initSpreadSelector() { const selector = document.getElementById('spreadSelector'); selector.addEventListener('click', (e) => { const btn = e.target.closest('.spread-btn'); if (btn) selectSpread(btn.dataset.spread); }); }
        function selectSpread(spread) { currentSpread = spread; document.querySelectorAll('.spread-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.spread === spread); }); setupSpread(spread); document.getElementById('resultSection').classList.remove('show'); }
        function setupSpread(spread) { const spreadInfo = spreads[spread]; const container = document.getElementById('tarotSpread'); const isLarge = spreadInfo.cards <= 3; container.innerHTML = ''; for (let i = 0; i < spreadInfo.cards; i++) { const wrapper = document.createElement('div'); wrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center;'; wrapper.innerHTML = `<div class="tarot-card ${isLarge ? 'large' : ''}" id="card${i}" onclick="flipCard(${i})"><div class="card-back">ğŸŒ™</div><div class="card-front"><span class="card-image">?</span><span class="card-name">ç¿»ç‰Œæ­æ›‰</span></div></div><div class="card-label">${spreadInfo.positions[i]}</div>`; container.appendChild(wrapper); } selectedCards = []; flippedCount = 0; canFlip = false; document.getElementById('drawBtn').disabled = false; document.getElementById('drawBtn').textContent = 'ğŸ”® é–‹å§‹å åœ'; document.getElementById('flipHint').style.display = 'none'; }
        function startDivine() { const btn = document.getElementById('drawBtn'); const flipMode = document.querySelector('input[name="flipMode"]:checked').value; btn.disabled = true; btn.textContent = 'ğŸ”® æ´—ç‰Œä¸­...'; flippedCount = 0; canFlip = false; selectedCards = []; document.getElementById('resultSection').classList.remove('show'); stopSpeech(); document.querySelectorAll('.tarot-card').forEach(card => { card.classList.remove('flipped', 'reversed'); card.style.pointerEvents = 'none'; }); const spreadInfo = spreads[currentSpread]; const shuffled = [...tarotDeck].sort(() => Math.random() - 0.5); selectedCards = shuffled.slice(0, spreadInfo.cards).map(card => ({ ...card, isReversed: settings.enableReversed && Math.random() > 0.5 })); selectedCards.forEach((card, index) => { const cardEl = document.getElementById(`card${index}`); const front = cardEl.querySelector('.card-front'); front.querySelector('.card-image').textContent = card.icon; front.querySelector('.card-name').textContent = card.name; if (card.isReversed) { cardEl.classList.add('reversed'); front.innerHTML += '<span class="reversed-mark">é€†</span>'; } }); playSfx('shuffle'); setTimeout(() => { if (flipMode === 'auto') { btn.textContent = 'ğŸ”® ç¿»ç‰Œä¸­...'; autoFlipCards(); } else { canFlip = true; document.querySelectorAll('.tarot-card').forEach(card => { card.style.pointerEvents = 'auto'; }); document.getElementById('flipHint').style.display = 'block'; btn.textContent = 'ğŸ‘† é»æ“Šå¡ç‰Œç¿»ç‰Œ'; } }, 800); }
        function autoFlipCards() { selectedCards.forEach((card, index) => { setTimeout(() => { document.getElementById(`card${index}`).classList.add('flipped'); playSfx('flip'); flippedCount++; if (flippedCount === selectedCards.length) setTimeout(() => showResult(), 500); }, index * 500); }); }
        function flipCard(index) { if (!canFlip) return; const cardEl = document.getElementById(`card${index}`); if (cardEl.classList.contains('flipped')) return; cardEl.classList.add('flipped'); playSfx('flip'); flippedCount++; if (flippedCount === selectedCards.length) { canFlip = false; document.getElementById('flipHint').style.display = 'none'; setTimeout(() => showResult(), 500); } }
        function showResult() { playSfx('magic'); const mainCard = selectedCards[0]; const isReversed = mainCard.isReversed; const scores = { overall: Math.floor(Math.random() * 30) + (isReversed ? 40 : 65), love: Math.floor(Math.random() * 40) + (isReversed ? 35 : 55), career: Math.floor(Math.random() * 40) + (isReversed ? 40 : 55), wealth: Math.floor(Math.random() * 40) + (isReversed ? 30 : 50) }; document.getElementById('resultHeader').innerHTML = `<div class="result-card-preview"><span>${mainCard.icon}</span><span class="name">${mainCard.name}</span></div><div class="result-info"><h3>${mainCard.name} ${isReversed ? '(é€†ä½)' : ''}</h3><p class="position">${spreads[currentSpread].positions[0]}</p><div class="keywords">${(isReversed ? mainCard.keywordsReversed : mainCard.keywords).map(k => `<span class="keyword ${isReversed ? 'reversed' : ''}">${k}</span>`).join('')}</div></div>`; updateScore('scoreOverall', scores.overall); updateScore('scoreLove', scores.love); updateScore('scoreCareer', scores.career); updateScore('scoreWealth', scores.wealth); document.getElementById('cardMeaning').textContent = isReversed ? mainCard.meaningReversed : mainCard.meaning; document.getElementById('cardAdvice').textContent = mainCard.advice; document.getElementById('resultSection').classList.add('show'); resetSpeechUI(); document.getElementById('aiReadingContent').textContent = 'æ­£åœ¨è«‹æ±‚ AI è§£è®€...'; document.getElementById('aiReadingContent').classList.add('loading'); getAIReading(); currentResult = { cards: selectedCards, scores: scores, spread: currentSpread, question: document.getElementById('questionInput').value }; addToHistory(currentResult); document.getElementById('drawBtn').disabled = false; document.getElementById('drawBtn').textContent = 'ğŸ”® é‡æ–°å åœ'; }
        function updateScore(id, score) { const el = document.getElementById(id); el.textContent = score; el.className = `score ${score >= 75 ? 'high' : score >= 50 ? 'mid' : 'low'}`; }
        async function getAIReading() { if (!settings.groqApiKey) { document.getElementById('aiReadingContent').textContent = 'è«‹åœ¨è¨­å®šä¸­è¼¸å…¥ Groq API Key ä»¥å•Ÿç”¨ AI è§£è®€åŠŸèƒ½ã€‚'; document.getElementById('aiReadingContent').classList.remove('loading'); return; } const question = document.getElementById('questionInput').value || 'ä»Šå¤©çš„é‹å‹¢å¦‚ä½•ï¼Ÿ'; const spreadInfo = spreads[currentSpread]; const cardsDescription = selectedCards.map((card, index) => `${spreadInfo.positions[index]}ï¼š${card.name}${card.isReversed ? 'ï¼ˆé€†ä½ï¼‰' : 'ï¼ˆæ­£ä½ï¼‰'}`).join('\n'); const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¡”ç¾…ç‰Œè§£è®€å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹è³‡è¨Šï¼Œç‚ºç”¨æˆ¶æä¾›æ·±å…¥ã€å€‹äººåŒ–çš„å¡”ç¾…è§£è®€ã€‚\n\nç”¨æˆ¶å•é¡Œï¼š${question}\n\nç‰Œé™£ï¼š${spreadInfo.name}\n\næŠ½åˆ°çš„ç‰Œï¼š\n${cardsDescription}\n\nè«‹æä¾›ï¼š\n1. é‡å°ç”¨æˆ¶å•é¡Œçš„æ•´é«”è§£è®€ï¼ˆ2-3å¥è©±ï¼‰\n2. å„å¼µç‰Œä¹‹é–“çš„é—œè¯åˆ†æ\n3. å…·é«”çš„å»ºè­°å’Œè¡Œå‹•æ–¹å‘\n\næ³¨æ„ï¼š\n- ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”\n- ä¿æŒç¥ç§˜ä½†æº«æš–çš„èªèª¿\n- è§£è®€è¦å…·é«”ã€æœ‰å»ºè¨­æ€§\n- æ§åˆ¶åœ¨ 200 å­—ä»¥å…§`; try { const response = await fetch('https://api.groq.com/openai/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.groqApiKey}` }, body: JSON.stringify({ model: settings.aiModel, messages: [{ role: 'system', content: 'ä½ æ˜¯ä¸€ä½å°ˆæ¥­ã€æº«æš–çš„å¡”ç¾…ç‰Œè§£è®€å¸«ï¼Œæ“…é•·ç”¨ç¹é«”ä¸­æ–‡æä¾›æ·±å…¥çš„å åœè§£è®€ã€‚' }, { role: 'user', content: prompt }], temperature: 0.8, max_tokens: 500 }) }); const data = await response.json(); if (data.choices && data.choices[0]) { document.getElementById('aiReadingContent').textContent = data.choices[0].message.content; currentResult.aiReading = data.choices[0].message.content; if (history.length > 0) { history[0].aiReading = data.choices[0].message.content; saveHistory(); } } else throw new Error('API å›æ‡‰æ ¼å¼éŒ¯èª¤'); } catch (error) { console.error('AI è§£è®€å¤±æ•—:', error); document.getElementById('aiReadingContent').textContent = 'AI è§£è®€æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹æª¢æŸ¥ API Key è¨­å®šã€‚'; } document.getElementById('aiReadingContent').classList.remove('loading'); }
        
        // ==================== èªéŸ³æ’­å ±ç³»çµ±ï¼ˆå®Œæ•´æ§åˆ¶ï¼‰====================
        function getChineseVoice() { const voices = speechSynthesis.getVoices(); return voices.find(v => v.lang.includes('zh-TW')) || voices.find(v => v.lang.includes('zh-CN')) || voices.find(v => v.lang.includes('zh')); }
        function generateSpeechText() { if (!currentResult) return ''; const mainCard = currentResult.cards[0]; const scores = currentResult.scores; const aiReading = currentResult.aiReading || ''; let text = `ä½ æŠ½åˆ°çš„ç‰Œæ˜¯${mainCard.name}${mainCard.isReversed ? 'é€†ä½' : ''}ã€‚`; text += `æ•´é«”é‹å‹¢${scores.overall}åˆ†ï¼Œæ„›æƒ…é‹${scores.love}åˆ†ï¼Œäº‹æ¥­é‹${scores.career}åˆ†ï¼Œè²¡é‹${scores.wealth}åˆ†ã€‚`; text += `ç‰Œç¾©è§£è®€ï¼š${mainCard.isReversed ? mainCard.meaningReversed : mainCard.meaning}ã€‚`; text += `å»ºè­°ï¼š${mainCard.advice}ã€‚`; if (aiReading) text += `AI æ™ºæ…§è§£è®€ï¼š${aiReading}`; return text; }
        function resetSpeechUI() { speechState = 'stopped'; const mainBtn = document.getElementById('voiceMainBtn'); const controls = document.getElementById('voiceControls'); const status = document.getElementById('voiceStatus'); const pauseBtn = document.getElementById('voicePauseBtn'); if (mainBtn) { mainBtn.innerHTML = 'ğŸ”Š èªéŸ³æ’­å ±'; mainBtn.classList.remove('playing', 'paused'); } if (controls) controls.style.display = 'none'; if (status) status.textContent = ''; if (pauseBtn) pauseBtn.innerHTML = 'â¸ï¸ æš«åœ'; }
        function updateSpeechUI() { const mainBtn = document.getElementById('voiceMainBtn'); const controls = document.getElementById('voiceControls'); const status = document.getElementById('voiceStatus'); const pauseBtn = document.getElementById('voicePauseBtn'); if (!mainBtn) return; mainBtn.classList.remove('playing', 'paused'); switch (speechState) { case 'playing': mainBtn.innerHTML = 'ğŸ”Š æ’­æ”¾ä¸­...'; mainBtn.classList.add('playing'); if (controls) controls.style.display = 'flex'; if (pauseBtn) { pauseBtn.innerHTML = 'â¸ï¸ æš«åœ'; pauseBtn.disabled = false; } if (status) status.textContent = 'ğŸ”Š æ­£åœ¨æ’­æ”¾èªéŸ³...'; break; case 'paused': mainBtn.innerHTML = 'â–¶ï¸ ç¹¼çºŒæ’­æ”¾'; mainBtn.classList.add('paused'); if (controls) controls.style.display = 'flex'; if (pauseBtn) { pauseBtn.innerHTML = 'â–¶ï¸ ç¹¼çºŒ'; pauseBtn.disabled = false; } if (status) status.textContent = 'â¸ï¸ èªéŸ³å·²æš«åœ'; break; case 'stopped': default: mainBtn.innerHTML = 'ğŸ”Š èªéŸ³æ’­å ±'; if (controls) controls.style.display = 'none'; if (status) status.textContent = ''; break; } }
        function toggleSpeech() { if (!currentResult) { showToast('âš ï¸ è«‹å…ˆé€²è¡Œå åœ'); return; } if (!('speechSynthesis' in window)) { showToast('âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½'); return; } switch (speechState) { case 'stopped': startSpeech(); break; case 'playing': pauseSpeech(); break; case 'paused': resumeSpeech(); break; } }
        function startSpeech() { speechSynthesis.cancel(); const text = generateSpeechText(); speechUtterance = new SpeechSynthesisUtterance(text); const voice = getChineseVoice(); if (voice) speechUtterance.voice = voice; speechUtterance.lang = 'zh-TW'; speechUtterance.rate = 0.9; speechUtterance.pitch = 1; speechUtterance.onstart = () => { speechState = 'playing'; updateSpeechUI(); }; speechUtterance.onend = () => { speechState = 'stopped'; updateSpeechUI(); showToast('âœ… èªéŸ³æ’­å ±å®Œæˆ'); }; speechUtterance.onerror = (e) => { console.error('èªéŸ³éŒ¯èª¤:', e); speechState = 'stopped'; updateSpeechUI(); if (e.error !== 'canceled') showToast('âŒ èªéŸ³æ’­æ”¾å¤±æ•—'); }; speechSynthesis.speak(speechUtterance); showToast('ğŸ”Š é–‹å§‹èªéŸ³æ’­å ±'); }
        function pauseSpeech() { if (speechState === 'playing') { speechSynthesis.pause(); speechState = 'paused'; updateSpeechUI(); showToast('â¸ï¸ èªéŸ³å·²æš«åœ'); } else if (speechState === 'paused') { resumeSpeech(); } }
        function resumeSpeech() { if (speechState === 'paused') { speechSynthesis.resume(); speechState = 'playing'; updateSpeechUI(); showToast('â–¶ï¸ ç¹¼çºŒæ’­æ”¾'); } }
        function stopSpeech() { speechSynthesis.cancel(); speechState = 'stopped'; updateSpeechUI(); }
        function replaySpeech() { stopSpeech(); setTimeout(() => startSpeech(), 100); }
        // ==================== èªéŸ³æ’­å ±ç³»çµ±çµæŸ ====================
        
        async function sendToLine() { if (!settings.gasUrl) { showToast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL'); showPage('settings'); return; } if (!currentResult) { showToast('âš ï¸ è«‹å…ˆé€²è¡Œå åœ'); return; } try { await fetch(settings.gasUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'sendTarot', result: { card: currentResult.cards[0], scores: currentResult.scores, date: new Date().toLocaleDateString('zh-TW'), aiReading: currentResult.aiReading } }) }); showToast('âœ… å·²ç™¼é€åˆ° LINEï¼'); } catch (error) { showToast('âŒ ç™¼é€å¤±æ•—'); console.error(error); } }
        function initCardGrid() { const container = document.getElementById('cardGrid'); container.innerHTML = tarotDeck.map(card => `<div class="card-learn-item" onclick="showCardDetail(${card.id})"><div class="icon">${card.icon}</div><div class="name">${card.name}</div></div>`).join(''); }
        function showCardDetail(id) { const card = tarotDeck.find(c => c.id === id); if (!card) return; document.getElementById('modalCardName').textContent = card.name; document.getElementById('modalCardIcon').textContent = card.icon; document.getElementById('modalCardEnName').textContent = card.enName; document.getElementById('modalKeywords').innerHTML = card.keywords.map(k => `<span class="keyword">${k}</span>`).join(''); document.getElementById('modalMeaningUpright').textContent = card.meaning; document.getElementById('modalMeaningReversed').textContent = card.meaningReversed; document.getElementById('modalAdvice').textContent = card.advice; showModal('cardDetailModal'); }
        function showPage(page) { if (page !== 'settings') saveSettings(); document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(`page-${page}`).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); const navItem = document.querySelector(`.nav-item[onclick="showPage('${page}')"]`); if (navItem) navItem.classList.add('active'); window.scrollTo(0, 0); }
        function showModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }
        function playSfx(type) { if (!settings.enableSfx) return; if (playCustomSound(type)) return; try { const audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (type === 'shuffle') { playShuffleSound(audioContext); } else if (type === 'flip') { playFlipSound(audioContext); } else if (type === 'magic') { playMagicSound(audioContext); } } catch (e) { console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e); } }
        
        function playShuffleSound(ctx) {
            // æ´—ç‰ŒéŸ³æ•ˆ - æ¨¡æ“¬ç´™ç‰Œå¿«é€Ÿç¿»å‹•
            const duration = 0.8;
            const numCards = 12;
            for (let i = 0; i < numCards; i++) {
                const delay = (i / numCards) * duration * 0.7;
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    const filter = ctx.createBiquadFilter();
                    filter.type = 'bandpass';
                    filter.frequency.value = 2000 + Math.random() * 3000;
                    filter.Q.value = 1;
                    osc.type = 'sawtooth';
                    osc.frequency.value = 100 + Math.random() * 200;
                    gain.gain.setValueAtTime(0.08, ctx.currentTime);
                    gain.gain.exponentialDecayTo && gain.gain.exponentialDecayTo(0.001, ctx.currentTime + 0.05);
                    gain.gain.setValueAtTime(0.08, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.001, ctx.currentTime + 0.05);
                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.05);
                }, delay * 1000);
            }
        }
        
        function playFlipSound(ctx) {
            // ç¿»ç‰ŒéŸ³æ•ˆ - æ¸…è„†çš„ç´™ç‰Œç¿»è½‰è²
            const noise = ctx.createBufferSource();
            const bufferSize = ctx.sampleRate * 0.15;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.1));
            }
            noise.buffer = buffer;
            const filter = ctx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;
            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.15);
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            noise.start();
            // åŠ å…¥ä¸€é»ä½é »æ•²æ“Šæ„Ÿ
            const osc = ctx.createOscillator();
            const oscGain = ctx.createGain();
            osc.frequency.value = 150;
            osc.type = 'sine';
            oscGain.gain.setValueAtTime(0.2, ctx.currentTime);
            oscGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.08);
            osc.connect(oscGain);
            oscGain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.08);
        }
        
        function playMagicSound(ctx) {
            // é­”æ³•éŸ³æ•ˆ - ç¥ç§˜çš„éŸ³æ•ˆ
            const osc1 = ctx.createOscillator();
            const osc2 = ctx.createOscillator();
            const gain = ctx.createGain();
            osc1.type = 'sine';
            osc2.type = 'sine';
            osc1.frequency.setValueAtTime(400, ctx.currentTime);
            osc1.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.5);
            osc2.frequency.setValueAtTime(600, ctx.currentTime);
            osc2.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
            osc1.connect(gain);
            osc2.connect(gain);
            gain.connect(ctx.destination);
            osc1.start();
            osc2.start();
            osc1.stop(ctx.currentTime + 0.5);
            osc2.stop(ctx.currentTime + 0.5);
        }
        
        // èƒŒæ™¯éŸ³æ¨‚ç³»çµ±
        let bgmContext = null;
        let bgmGain = null;
        let bgmPlaying = false;
        let bgmNodes = [];
        let customBgmAudioElement = null;
        
        function startBgm() {
            if (bgmPlaying || !settings.enableBgm) return;
            const customBgmData = localStorage.getItem('customBgm');
            if (customBgmData) {
                // ä½¿ç”¨è‡ªè¨‚èƒŒæ™¯éŸ³æ¨‚
                customBgmAudioElement = new Audio(customBgmData);
                customBgmAudioElement.loop = true;
                customBgmAudioElement.volume = 0.3;
                customBgmAudioElement.play().catch(e => console.log('BGM æ’­æ”¾å¤±æ•—:', e));
                bgmPlaying = true;
            } else {
                // ä½¿ç”¨åˆæˆèƒŒæ™¯éŸ³æ¨‚
                try {
                    bgmContext = new (window.AudioContext || window.webkitAudioContext)();
                    bgmGain = bgmContext.createGain();
                    bgmGain.gain.value = 0.15;
                    bgmGain.connect(bgmContext.destination);
                    bgmPlaying = true;
                    playAmbientLoop();
                } catch (e) { console.log('èƒŒæ™¯éŸ³æ¨‚å•Ÿå‹•å¤±æ•—:', e); }
            }
        }
        
        function stopBgm() {
            bgmPlaying = false;
            if (customBgmAudioElement) {
                customBgmAudioElement.pause();
                customBgmAudioElement.currentTime = 0;
                customBgmAudioElement = null;
            }
            bgmNodes.forEach(node => { try { node.stop(); } catch(e){} });
            bgmNodes = [];
            if (bgmContext) { bgmContext.close(); bgmContext = null; }
        }
        
        function playAmbientLoop() {
            if (!bgmPlaying || !bgmContext) return;
            // ç¥ç§˜æ°›åœéŸ³ - ä½é » drone + é«˜é »é–ƒçˆ
            const now = bgmContext.currentTime;
            // ä½é »æŒçºŒéŸ³
            const drone = bgmContext.createOscillator();
            const droneGain = bgmContext.createGain();
            drone.type = 'sine';
            drone.frequency.value = 80;
            droneGain.gain.setValueAtTime(0.3, now);
            droneGain.gain.setValueAtTime(0.3, now + 3.5);
            droneGain.gain.linearRampToValueAtTime(0, now + 4);
            drone.connect(droneGain);
            droneGain.connect(bgmGain);
            drone.start(now);
            drone.stop(now + 4);
            bgmNodes.push(drone);
            // ç¥ç§˜å’Œå¼¦
            const chordFreqs = [130.81, 196, 261.63, 392]; // C3, G3, C4, G4
            chordFreqs.forEach((freq, i) => {
                const osc = bgmContext.createOscillator();
                const oscGain = bgmContext.createGain();
                osc.type = 'sine';
                osc.frequency.value = freq;
                oscGain.gain.setValueAtTime(0, now + i * 0.3);
                oscGain.gain.linearRampToValueAtTime(0.08, now + i * 0.3 + 0.5);
                oscGain.gain.setValueAtTime(0.08, now + 3);
                oscGain.gain.linearRampToValueAtTime(0, now + 4);
                osc.connect(oscGain);
                oscGain.connect(bgmGain);
                osc.start(now + i * 0.3);
                osc.stop(now + 4);
                bgmNodes.push(osc);
            });
            // å¾ªç’°
            setTimeout(() => { if (bgmPlaying) playAmbientLoop(); }, 3800);
        }
        function toggleSound() { settings.enableSfx = !settings.enableSfx; saveSettings(); showToast(settings.enableSfx ? 'ğŸ”Š éŸ³æ•ˆå·²é–‹å•Ÿ' : 'ğŸ”‡ éŸ³æ•ˆå·²é—œé–‰'); }
        function toggleBgm() { if (bgmPlaying) { stopBgm(); settings.enableBgm = false; showToast('ğŸ”‡ èƒŒæ™¯éŸ³æ¨‚å·²é—œé–‰'); } else { settings.enableBgm = true; startBgm(); showToast('ğŸµ èƒŒæ™¯éŸ³æ¨‚å·²é–‹å•Ÿ'); } saveSettings(); }
        
        // è‡ªè¨‚éŸ³æ•ˆç³»çµ±
        let customSounds = { flip: null, shuffle: null, magic: null };
        let customBgmAudio = null;
        
        function loadCustomSound(type, input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                customSounds[type] = e.target.result;
                localStorage.setItem('customSound_' + type, e.target.result);
                showToast('âœ… å·²è¼‰å…¥è‡ªè¨‚' + (type === 'flip' ? 'ç¿»ç‰Œ' : type === 'shuffle' ? 'æ´—ç‰Œ' : 'çµæœ') + 'éŸ³æ•ˆ');
            };
            reader.readAsDataURL(file);
        }
        
        function clearCustomSound(type) {
            customSounds[type] = null;
            localStorage.removeItem('customSound_' + type);
            document.getElementById('customFlipSound').value = '';
            document.getElementById('customShuffleSound').value = '';
            document.getElementById('customMagicSound').value = '';
            showToast('ğŸ—‘ï¸ å·²æ¸…é™¤è‡ªè¨‚éŸ³æ•ˆ');
        }
        
        function loadCustomBgm(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                localStorage.setItem('customBgm', e.target.result);
                showToast('âœ… å·²è¼‰å…¥è‡ªè¨‚èƒŒæ™¯éŸ³æ¨‚');
                if (bgmPlaying) { stopBgm(); startBgm(); }
            };
            reader.readAsDataURL(file);
        }
        
        function clearCustomBgm() {
            localStorage.removeItem('customBgm');
            document.getElementById('customBgm').value = '';
            if (bgmPlaying) { stopBgm(); startBgm(); }
            showToast('ğŸ—‘ï¸ å·²æ¸…é™¤è‡ªè¨‚èƒŒæ™¯éŸ³æ¨‚');
        }
        
        function loadSavedCustomSounds() {
            ['flip', 'shuffle', 'magic'].forEach(type => {
                const saved = localStorage.getItem('customSound_' + type);
                if (saved) customSounds[type] = saved;
            });
        }
        
        function playCustomSound(type) {
            if (customSounds[type]) {
                const audio = new Audio(customSounds[type]);
                audio.volume = 0.5;
                audio.play().catch(e => console.log('æ’­æ”¾å¤±æ•—:', e));
                return true;
            }
            return false;
        }
        function exportData() { const data = { settings: settings, history: history, exportDate: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tarot-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); showToast('ğŸ“¤ è³‡æ–™å·²åŒ¯å‡º'); }
    </script>
</body>
</html>
